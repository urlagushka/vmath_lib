/* File converted with FORTRAN CONVERTER utility.
   FORTRAN CONVERTER is written by Grigoriev D., 2081/4.*/

/*MARKERS: //! = probably incorrect, //? = possibly incorrect*/

#include "forsythe.h"


void SVD(int M,int N,REAL **A,REAL *W,bool MATU,REAL **U,bool MATV,REAL **V,int &IERR,REAL *RV1)
{

int I,J,K,L,II,I1,KK,K1,LL,L1,ITS,MN;
REAL C,F,G,H,S,X,Y,Z,SCALE,ANORM;


//     TA OPOPAMMA ECT TPAHC AO-POEP SVD,
//     OKOBAHHO OOM  PAHEM B PHAE NUMERISCHE
//     MATHEMATIK, 14, 403-420(1970), A TAKE B KHE
//     HANDBOOK FOR AUTOMATIC COMPUTATION  VOL.II-LINEAR
//     ALGEBRA, 134-151 (1971).

//     TA OPOPAMMA BCET CHPHOE PAOEHE
//     A=USV'  ECTBTEHO PMOOHO MATP A C PAME-
//     PAM M  N. P TOM COTC BXAOHAA
//     OCPECTBOM XACXOEPOBX OTPAEH   BAPAHT
//     QR-AOPTMA.

//     HA BXOE.

//     NM   CEET OOT PABHM CTPOHO PAMEPHOCT
//          BXMEPHX MACCBOB ,ABEHHO B OEPATOPE PA-
//          MEPHOCT BBAE POPAMM. AMETM, TO NM
//          OHO T H  MEHE,EM MAKCMM  M  N.

//     M    CO CTPOK A ( U).

//     N    CO CTOOB A ( U)  OPOK V.

//     A    COEPT PMOOH BXOH MATP, 
//          KOTOPO HAXOTC  PAOEHE.

//     MATU OEH MET HAEHE true, EC HHO
//          BCT MATP U  PAOEH,  HAEHE
//          false B POTBHOM CAE.

//     MATV OEH MET HAEHE true, EC HHO
//          BCT MATP V  PAOEH,  HAEHE
//          false B POTBHOM CAE.

//     HA BXOE.

//     A    HE MEHETC (EC HA EE MECTE HE ACBATC
//          U O V).

//     W    COEPT N (HEOTPATEHX) CHPHX CE
//          A (AOHAHX EMEHTOB S). OH HE OPOEH.
//          EC POCXOT BXO O OKE, TO  HAEH
//          IERR+1, IERR+2,...,N CH PHE CA OH
//          T BEPH.

//     U    COEPT MATP U (C OPTOOHAHM CTOAM)
//           PAOEH, EC  APAMETPA MATU O
//          AAHO HAEHE true B POTBHOM CAE HA U
//          COETC KAK BPEMEHH MACCB. U TAKE MOET
//          COBAAT C A. EC POCXOT BXO
//          O OKE, TO CTO U, COOTBETCTBE HEKCAM
//          BEPHX CHPHX CE, OH T TAKE BEPH.

//     V    COEPT MATP V (OPTOOHAH)  PAOEH,
//          EC  APAMETPA MATV O AAHO HAEHE
//          true B POTBHOM CAE HA V HE POBOTC
//          CCOK. V TAKE MOET COBAAT C  A, EC U HE
//          BCETC. EC POCXOT BXO O OKE,
//          TO CTO V, COOTBETCTBE HEKCAM BEPHX
//          CHPHX CE, OH T TAKE BEPH.

//     IERR PABHO
//            0,  EC POCXOT HOPMAH BXO  OPO-
//                PAMM,
//            K,  EC K-E CHPHOE CO HE O OPEE-
//                EHO OCE 30 TEPA.

//     RV1  TO MACCB POMETOHOO XPAHEH.

//     BOPOC  KOMMEHTAP HHO HAPABT O APEC
//     B.S.GARBOW, APPLIED MATEMATICS DIVISION, ARGONNE
//     NATIONAL LABORATORY

//     OPOPAMMA MOPOBAHA C E CKT
//     EPEMEHHY MACHEP

IERR=0;
for( I=1; I<=M; I++){   //? target=100
for( J=1; J<=N; J++){   //? target=100
U[I-1][J-1]=A[I-1][J-1];
//_100:;
}
}                         	// CONTINUE

//     XACXOEPOBO PBEEHE K BXAOHAHO OPME

G=0.0;
SCALE=0.0;
ANORM=0.0;

for( I=1; I<=N; I++){   //? target=300
L=I+1;
RV1[I-1]=SCALE*G;
G=0.0;
S=0.0;
SCALE=0.0;
if(I>M)goto _210;

for( K=I; K<=M; K++)SCALE=SCALE+ABS(U[K-1][I-1]);
if(SCALE==0.0)goto _210;

for( K=I; K<=M; K++){   //? target=130
U[K-1][I-1]=U[K-1][I-1]/SCALE;
S=S+U[K-1][I-1]*U[K-1][I-1];
//_130:;
}                         	// CONTINUE

F=U[I-1][I-1];
G=-SIGN(SQRT(S),F);
H=F*G-S;
U[I-1][I-1]=F-G;
if(I==N)goto _190;

for( J=L; J<=N; J++){   //? target=150
S=0.0;
for( K=I; K<=M; K++)S=S+U[K-1][I-1]*U[K-1][J-1];
F=S/H;
for( K=I; K<=M; K++){   //? target=150
U[K-1][J-1]=U[K-1][J-1]+F*U[K-1][I-1];
//_150:;
}
}                         	// CONTINUE

_190:;
for( K=I; K<=M; K++)U[K-1][I-1]=SCALE*U[K-1][I-1];
_210:;
W[I-1]=SCALE*G;
G=0.0;
S=0.0;
SCALE=0.0;
if(I>M||I==N)goto _290;

for( K=L; K<=N; K++)SCALE=SCALE+ABS(U[I-1][K-1]);

if(SCALE==0.0)goto _290;

for( K=L; K<=N; K++){   //? target=230
U[I-1][K-1]=U[I-1][K-1]/SCALE;
S=S+U[I-1][K-1]*U[I-1][K-1];
//_230:;
}                         	// CONTINUE

F=U[I-1][L-1];
G=-SIGN(SQRT(S),F);
H=F*G-S;
U[I-1][L-1]=F-G;

for( K=L; K<=N; K++)RV1[K-1]=U[I-1][K-1]/H;

if(I==M)goto _270;

for( J=L; J<=M; J++){   //? target=260
S=0.0;
for( K=L; K<=N; K++)S=S+U[J-1][K-1]*U[I-1][K-1];
for( K=L; K<=N; K++){   //? target=260
U[J-1][K-1]=U[J-1][K-1]+S*RV1[K-1];
//_260:;
}
}                         	// CONTINUE

_270:;
for( K=L; K<=N; K++)U[I-1][K-1]=SCALE*U[I-1][K-1];

_290:;
ANORM=MAX(ANORM,ABS(W[I-1])+ABS(RV1[I-1]));
//_300:;
}                         	// CONTINUE

//     HAKOEHE PABOCTOPOHHX PEOPAOBAH

if(!MATV)goto _410;

//      I=N C AOM -1 O 1 BOHT -

for( II=1; II<=N; II++){   //? target=400
I=N+1-II;
if(I==N)goto _390;
if(G==0.0)goto _360;

for( J=L; J<=N; J++){   //? target=320

//     BOHOE EEHE OXOT BOMOH MAHH HY

//_320:;
V[J-1][I-1]=(U[I-1][J-1]/U[I-1][L-1])/G;
}

for( J=L; J<=N; J++){   //? target=350
S=0.0;
for( K=L; K<=N; K++)S=S+U[I-1][K-1]*V[K-1][J-1];
for( K=L; K<=N; K++){   //? target=350
V[K-1][J-1]=V[K-1][J-1]+S*V[K-1][I-1];
//_350:;
}
}                         	// CONTINUE

_360:;
for( J=L; J<=N; J++){   //? target=380
V[I-1][J-1]=0.0;
V[J-1][I-1]=0.0;
//_380:;
}                         	// CONTINUE

_390:;
V[I-1][I-1]=1.0;
G=RV1[I-1];
L=I;
//_400:;
}                         	// CONTINUE

//     HAKOEHE EBOCTOPOHHX PEOPAOBAH

_410:;
if(!MATU)goto _510;

//      I=MIN(N,M) C AOM -1 O 1 BOHT-

MN=N;
if(M<N)MN=M;

for( II=1; II<=MN; II++){   //? target=500
I=MN+1-II;
L=I+1;
G=W[I-1];
if(I==N)goto _430;

for( J=L; J<=N; J++)U[I-1][J-1]=0.0;

_430:;
if(G==0.0)goto _475;
if(I==MN)goto _460;

for( J=L; J<=N; J++){   //? target=450
S=0.0;
for( K=L; K<=M; K++)S=S+U[K-1][I-1]*U[K-1][J-1];

//     BOHOE  EEHE OXOT BOMOH MAHH HY

F=(S/U[I-1][I-1])/G;

for( K=I; K<=M; K++){   //? target=450
U[K-1][J-1]=U[K-1][J-1]+F*U[K-1][I-1];
//_450:;
}
}                         	// CONTINUE
_460:;
for( J=I; J<=M; J++)U[J-1][I-1]=U[J-1][I-1]/G;

goto _490;

_475:;
for( J=I; J<=M; J++)U[J-1][I-1]=0.0;

_490:;
U[I-1][I-1]=U[I-1][I-1]+1.0;
//_500:;
}                         	// CONTINUE

//     AOHAA BXAOHAHO OPM  K=N C AOM
//     -1 O 1 BOHT

_510:;
for( KK=1; KK<=N; KK++){   //? target=700
K1=N-KK;
K=K1+1;
ITS=0;

//     POBEPKA BOMOHOCT PACEEH   L=K
//     C AOM -1 O 1 BOHT

_520:;
for( LL=1; LL<=K; LL++){   //? target=530
L1=K-LL;
L=L1+1;
if(ABS(RV1[L-1])+ANORM==ANORM)goto _565;

//     RV1[0] BCEA PABHO H. OTOM BXOA
//     EPE KOHE KA HE ET

if(ABS(W[L1-1])+ANORM==ANORM)goto _540;
//_530:;
}                         	// CONTINUE

//      EC L OE, EM 1, TO RV1[L-1]
//      PCBABAETC HEBOE HAEHE

_540:;
C=0.0;
S=1.0;

for( I=L; I<=K; I++){   //? target=560
F=S*RV1[I-1];
RV1[I-1]=C*RV1[I-1];
if(ABS(F)+ANORM==ANORM)goto _565;
G=W[I-1];
H=SQRT(F*F+G*G);
W[I-1]=H;
C=G/H;
S=-F/H;
if(!MATU)goto _560;

for( J=1; J<=M; J++){   //? target=550
Y=U[J-1][L1-1];
Z=U[J-1][I-1];
U[J-1][L1-1]=Y*C+Z*S;
U[J-1][I-1]=-Y*S+Z*C;
//_550:;
}                         	// CONTINUE
_560:;
}                         	// CONTINUE

//     POBEPKA CXOMOCT

_565:;
Z=W[K-1];
if(L==K)goto _650;

//     CB BPAETC  HHEO OBOO
//     MHOPA OPKA 2

if(ITS==30)goto _1000;
ITS=ITS+1;
X=W[L-1];
Y=W[K1-1];
G=RV1[K1-1];
H=RV1[K-1];
F=((Y-Z)*(Y+Z)+(G-H)*(G+H))/(2.0*H*Y);
G=SQRT(F*F+1.0);
F=((X-Z)*(X+Z)+H*(Y/(F+SIGN(G,F))-H))/X;

//     CEEE QR-PEOPAOBAHE

C=1.0;
S=1.0;

for( I1=L; I1<=K1; I1++){   //? target=600
I=I1+1;
G=RV1[I-1];
Y=W[I-1];
H=S*G;
G=C*G;
Z=SQRT(F*F+H*H);
RV1[I1-1]=Z;
C=F/Z;
S=H/Z;
F=X*C+G*S;
G=-X*S+G*C;
H=Y*S;
Y=Y*C;
if(!MATV)goto _575;

for( J=1; J<=N; J++){   //? target=570
X=V[J-1][I1-1];
Z=V[J-1][I-1];
V[J-1][I1-1]=X*C+Z*S;
V[J-1][I-1]=-X*S+Z*C;
//_570:;
}                         	// CONTINUE

_575:;
Z=SQRT(F*F+H*H);
W[I1-1]=Z;

//     BPAEHE MOET T POBOHM, EC Z PABHO H

if(Z==0.0)goto _580;
C=F/Z;
S=H/Z;
_580:;
F=C*G+S*Y;
X=-S*G+C*Y;
if(!MATU)goto _600;

for( J=1; J<=M; J++){   //? target=590
Y=U[J-1][I1-1];
Z=U[J-1][I-1];
U[J-1][I1-1]=Y*C+Z*S;
U[J-1][I-1]=-Y*S+Z*C;
//_590:;
}                         	// CONTINUE
_600:;
}                         	// CONTINUE
RV1[L-1]=0.0;
RV1[K-1]=F;
W[K-1]=X;
goto _520;

//     CXOMOCT

_650:;
if(Z>=0.0)goto _700;

//     W[K-1] EAETC HEOTPATEHM

W[K-1]=-Z;
if(!MATV)goto _700;

for( J=1; J<=N; J++)V[J-1][K-1]=-V[J-1][K-1];
_700:;
}                         	// CONTINUE
goto _1001;

//     CTAHOBT HAEHE PHAKA OK - OCE 30
//     TEPA HET CXOMOCT K CHPHOM C

_1000:;
IERR=K;
_1001:;
return;
}                         	// END
